{"version":3,"file":"index.js","sources":["../../../../../src/index.tsx"],"sourcesContent":["import * as React from 'react'\nimport { useRect, Rect } from './useRect'\nimport { useIsomorphicLayoutEffect } from './useIsomorphicLayoutEffect'\n\nconst defaultEstimateSize = () => 50\n\nconst defaultKeyExtractor = (index: number) => index\n\nconst defaultMeasureSize = (el: HTMLElement, horizontal: boolean) => {\n  const key = horizontal ? 'offsetWidth' : 'offsetHeight'\n\n  return el[key]\n}\n\ntype ScrollAlignment = 'start' | 'center' | 'end' | 'auto'\n\ninterface ScrollToOptions {\n  align: ScrollAlignment\n}\n\ninterface ScrollToOffsetOptions extends ScrollToOptions {}\n\ninterface ScrollToIndexOptions extends ScrollToOptions {}\n\nexport interface Range {\n  start: number\n  end: number\n  overscan: number\n  size: number\n}\n\nexport const defaultRangeExtractor = (range: Range) => {\n  const start = Math.max(range.start - range.overscan, 0)\n  const end = Math.min(range.end + range.overscan, range.size - 1)\n\n  const arr = []\n\n  for (let i = start; i <= end; i++) {\n    arr.push(i)\n  }\n\n  return arr\n}\n\ntype Key = number | string\n\ninterface Item {\n  key: Key\n  index: number\n  start: number\n  end: number\n  size: number\n}\n\nexport interface VirtualItem extends Item {\n  measureRef: (el: HTMLElement | null) => void\n}\n\nexport interface Options<T> {\n  size: number\n  parentRef: React.RefObject<T>\n  estimateSize?: (index: number) => number\n  overscan?: number\n  horizontal?: boolean\n  scrollToFn?: (\n    offset: number,\n    defaultScrollToFn?: (offset: number) => void,\n  ) => void\n  paddingStart?: number\n  paddingEnd?: number\n  useObserver?: (ref: React.RefObject<T>, initialRect?: Rect) => Rect\n  initialRect?: Rect\n  keyExtractor?: (index: number) => Key\n  onScrollElement?: React.RefObject<HTMLElement>\n  scrollOffsetFn?: (event?: Event) => number\n  rangeExtractor?: (range: Range) => number[]\n  measureSize?: (el: HTMLElement, horizontal: boolean) => number\n}\n\nexport const useVirtual = <T extends HTMLElement>({\n  size = 0,\n  estimateSize = defaultEstimateSize,\n  overscan = 1,\n  paddingStart = 0,\n  paddingEnd = 0,\n  parentRef,\n  horizontal = false,\n  scrollToFn,\n  useObserver,\n  initialRect,\n  onScrollElement,\n  scrollOffsetFn,\n  keyExtractor = defaultKeyExtractor,\n  measureSize = defaultMeasureSize,\n  rangeExtractor = defaultRangeExtractor,\n}: Options<T>) => {\n  const sizeKey = horizontal ? 'width' : 'height'\n  const scrollKey = horizontal ? 'scrollLeft' : 'scrollTop'\n\n  const latestRef = React.useRef<{\n    scrollOffset: number\n    measurements: Item[]\n    outerSize: number\n    totalSize: number\n  }>({\n    outerSize: 0,\n    scrollOffset: 0,\n    measurements: [],\n    totalSize: 0,\n  })\n\n  const [scrollOffset, setScrollOffset] = React.useState(0)\n  latestRef.current.scrollOffset = scrollOffset\n\n  const useMeasureParent = useObserver || useRect\n\n  const { [sizeKey]: outerSize } = useMeasureParent(parentRef, initialRect)\n\n  latestRef.current.outerSize = outerSize\n\n  const defaultScrollToFn = React.useCallback(\n    (offset: number) => {\n      if (parentRef.current) {\n        parentRef.current[scrollKey] = offset\n      }\n    },\n    [parentRef, scrollKey],\n  )\n\n  const resolvedScrollToFn = scrollToFn || defaultScrollToFn\n\n  const scrollTo = React.useCallback(\n    (offset: number) => {\n      resolvedScrollToFn(offset, defaultScrollToFn)\n    },\n    [defaultScrollToFn, resolvedScrollToFn],\n  )\n\n  const [measuredCache, setMeasuredCache] = React.useState<Record<Key, number>>(\n    {},\n  )\n\n  const measure = React.useCallback(() => setMeasuredCache({}), [])\n\n  const pendingMeasuredCacheIndexesRef = React.useRef<number[]>([])\n\n  const measurements = React.useMemo(() => {\n    const min =\n      pendingMeasuredCacheIndexesRef.current.length > 0\n        ? Math.min(...pendingMeasuredCacheIndexesRef.current)\n        : 0\n    pendingMeasuredCacheIndexesRef.current = []\n\n    const measurements = latestRef.current.measurements.slice(0, min)\n\n    for (let i = min; i < size; i++) {\n      const key = keyExtractor(i)\n      const measuredSize = measuredCache[key]\n      const start = measurements[i - 1] ? measurements[i - 1].end : paddingStart\n      const size =\n        typeof measuredSize === 'number' ? measuredSize : estimateSize(i)\n      const end = start + size\n      measurements[i] = { index: i, start, size, end, key }\n    }\n    return measurements\n  }, [estimateSize, measuredCache, paddingStart, size, keyExtractor])\n\n  const totalSize = (measurements[size - 1]?.end || paddingStart) + paddingEnd\n\n  latestRef.current.measurements = measurements\n  latestRef.current.totalSize = totalSize\n\n  const element = onScrollElement ? onScrollElement.current : parentRef.current\n\n  const scrollOffsetFnRef = React.useRef(scrollOffsetFn)\n  scrollOffsetFnRef.current = scrollOffsetFn\n\n  useIsomorphicLayoutEffect(() => {\n    if (!element) {\n      setScrollOffset(0)\n\n      return\n    }\n\n    const onScroll = (event?: Event) => {\n      const offset = scrollOffsetFnRef.current\n        ? scrollOffsetFnRef.current(event)\n        : element[scrollKey]\n\n      setScrollOffset(offset)\n    }\n\n    onScroll()\n\n    element.addEventListener('scroll', onScroll, {\n      capture: false,\n      passive: true,\n    })\n\n    return () => {\n      element.removeEventListener('scroll', onScroll)\n    }\n  }, [element, scrollKey])\n\n  const { start, end } = calculateRange(latestRef.current)\n\n  const indexes = React.useMemo(\n    () =>\n      rangeExtractor({\n        start,\n        end,\n        overscan,\n        size: measurements.length,\n      }),\n    [start, end, overscan, measurements.length, rangeExtractor],\n  )\n\n  const measureSizeRef = React.useRef(measureSize)\n  measureSizeRef.current = measureSize\n\n  const virtualItems: VirtualItem[] = React.useMemo(() => {\n    const virtualItems = []\n\n    for (let k = 0, len = indexes.length; k < len; k++) {\n      const i = indexes[k]\n      const measurement = measurements[i]\n\n      const item = {\n        ...measurement,\n        measureRef: (el: HTMLElement | null) => {\n          if (el) {\n            const measuredSize = measureSizeRef.current(el, horizontal)\n\n            if (measuredSize !== item.size) {\n              const { scrollOffset } = latestRef.current\n\n              if (item.start < scrollOffset) {\n                defaultScrollToFn(scrollOffset + (measuredSize - item.size))\n              }\n\n              pendingMeasuredCacheIndexesRef.current.push(i)\n\n              setMeasuredCache((old) => ({\n                ...old,\n                [item.key]: measuredSize,\n              }))\n            }\n          }\n        },\n      }\n\n      virtualItems.push(item)\n    }\n\n    return virtualItems\n  }, [indexes, defaultScrollToFn, horizontal, measurements])\n\n  const mountedRef = React.useRef(false)\n\n  useIsomorphicLayoutEffect(() => {\n    if (mountedRef.current) {\n      setMeasuredCache({})\n    }\n    mountedRef.current = true\n  }, [estimateSize])\n\n  const scrollToOffset = React.useCallback(\n    (\n      toOffset: number,\n      { align }: ScrollToOffsetOptions = { align: 'start' },\n    ) => {\n      const { scrollOffset, outerSize } = latestRef.current\n\n      if (align === 'auto') {\n        if (toOffset <= scrollOffset) {\n          align = 'start'\n        } else if (toOffset >= scrollOffset + outerSize) {\n          align = 'end'\n        } else {\n          align = 'start'\n        }\n      }\n\n      if (align === 'start') {\n        scrollTo(toOffset)\n      } else if (align === 'end') {\n        scrollTo(toOffset - outerSize)\n      } else if (align === 'center') {\n        scrollTo(toOffset - outerSize / 2)\n      }\n    },\n    [scrollTo],\n  )\n\n  const tryScrollToIndex = React.useCallback(\n    (\n      index: number,\n      { align, ...rest }: ScrollToIndexOptions = { align: 'auto' },\n    ) => {\n      const { measurements, scrollOffset, outerSize } = latestRef.current\n\n      const measurement = measurements[Math.max(0, Math.min(index, size - 1))]\n\n      if (!measurement) {\n        return\n      }\n\n      if (align === 'auto') {\n        if (measurement.end >= scrollOffset + outerSize) {\n          align = 'end'\n        } else if (measurement.start <= scrollOffset) {\n          align = 'start'\n        } else {\n          return\n        }\n      }\n\n      const toOffset =\n        align === 'center'\n          ? measurement.start + measurement.size / 2\n          : align === 'end'\n          ? measurement.end\n          : measurement.start\n\n      scrollToOffset(toOffset, { align, ...rest })\n    },\n    [scrollToOffset, size],\n  )\n\n  const scrollToIndex = React.useCallback(\n    (index: number, options?: ScrollToIndexOptions) => {\n      // We do a double request here because of\n      // dynamic sizes which can cause offset shift\n      // and end up in the wrong spot. Unfortunately,\n      // we can't know about those dynamic sizes until\n      // we try and render them. So double down!\n      tryScrollToIndex(index, options)\n      requestAnimationFrame(() => {\n        tryScrollToIndex(index, options)\n      })\n    },\n    [tryScrollToIndex],\n  )\n\n  return {\n    virtualItems,\n    totalSize,\n    scrollToOffset,\n    scrollToIndex,\n    measure,\n  }\n}\n\nconst findNearestBinarySearch = (\n  low: number,\n  high: number,\n  getCurrentValue: (i: number) => number,\n  value: number,\n) => {\n  while (low <= high) {\n    let middle = ((low + high) / 2) | 0\n    let currentValue = getCurrentValue(middle)\n\n    if (currentValue < value) {\n      low = middle + 1\n    } else if (currentValue > value) {\n      high = middle - 1\n    } else {\n      return middle\n    }\n  }\n\n  if (low > 0) {\n    return low - 1\n  } else {\n    return 0\n  }\n}\n\nfunction calculateRange({\n  measurements,\n  outerSize,\n  scrollOffset,\n}: {\n  measurements: Item[]\n  outerSize: number\n  scrollOffset: number\n}) {\n  const size = measurements.length - 1\n  const getOffset = (index: number) => measurements[index].start\n\n  let start = findNearestBinarySearch(0, size, getOffset, scrollOffset)\n  let end = start\n\n  while (end < size && measurements[end].end < scrollOffset + outerSize) {\n    end++\n  }\n\n  return { start, end }\n}\n"],"names":["defaultEstimateSize","defaultKeyExtractor","index","defaultMeasureSize","el","horizontal","key","defaultRangeExtractor","range","start","Math","max","overscan","end","min","size","arr","i","push","useVirtual","estimateSize","paddingStart","paddingEnd","parentRef","scrollToFn","useObserver","initialRect","onScrollElement","scrollOffsetFn","keyExtractor","measureSize","rangeExtractor","sizeKey","scrollKey","latestRef","React","useRef","outerSize","scrollOffset","measurements","totalSize","useState","setScrollOffset","current","useMeasureParent","useRect","defaultScrollToFn","useCallback","offset","resolvedScrollToFn","scrollTo","measuredCache","setMeasuredCache","measure","pendingMeasuredCacheIndexesRef","useMemo","length","slice","measuredSize","element","scrollOffsetFnRef","useIsomorphicLayoutEffect","onScroll","event","addEventListener","capture","passive","removeEventListener","calculateRange","indexes","measureSizeRef","virtualItems","k","len","measurement","item","measureRef","old","mountedRef","scrollToOffset","toOffset","align","tryScrollToIndex","rest","scrollToIndex","options","requestAnimationFrame","findNearestBinarySearch","low","high","getCurrentValue","value","middle","currentValue","getOffset"],"mappings":"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"}