function e(e,t,r,n){let o=[k.run({fn:e=>t(e)})];if(n&&o.unshift(n),r){let t=v({node:o}),n=e.graphite.id,u=r.additionalLinks,s=u[n]||[];return u[n]=s,s.push(t),()=>{let e=s.indexOf(t);-1!==e&&s.splice(e,1),g(t)}}{let t=v({node:o,parent:[e],family:{owners:e}});return()=>{g(t)}}}function t(e,t){return t.displayName=e,t}function r(t,r){S.store(t)||A('expect useStore argument to be a store');let n=y.useCallback((n=>e(t,n,r)),[t,r]),o=y.useCallback((()=>M(t,r)),[t,r]);return E(n,o,o)}function n([t,r],n){let o,u,s,a,l=R;r?(o=r,s=t,a=[]):({fn:o,store:s,keys:a,defaultValue:u,updateFilter:l=R}=t),S.store(s)||A('useStoreMap expects a store'),Array.isArray(a)||A('useStoreMap expects an array as keys'),'function'!=typeof o&&A('useStoreMap expects a function');let i=y.useCallback((t=>e(s,t,n)),[s,n]),c=y.useCallback((()=>M(s,n)),[s,n]),f=y.useRef(),p=y.useRef(),d=y.useRef(a);return w(i,c,c,(e=>{if(f.current!==e||!((e,t)=>{if(!e||!t||e.length!==t.length)return 0;let r=1;for(let n=0;n<e.length;n++)if(e[n]!==t[n]){r=0;break}return r})(d.current,a)){let t=o(e,a);void 0===t&&void 0!==u&&(t=u),f.current=e,d.current=a,void 0!==t&&(p.current=t)}return p.current}),((e,t)=>!l(t,e)))}function o(e,t){let r=t?e:e[0];var n;(e=>{if(!e)throw Error('expect first argument be an object')})(N(n=r)||(e=>'function'==typeof e)(n));let u=r.or,s=r.and;if(s){let r=t?s:s[0];if(N(r)&&'and'in r){let r=o(s,t);e=r[0],u={...u,...r[1]}}else e=s}return[e,u]}function u(e,t){let r=t&&N(n=t[0])&&(n.and||n.or)?t:[{and:t}];var n;let u,[[s,a],l]=o(r),i={},c={},f=l;var p;return'string'==typeof s?(c={name:s},N(p=a)&&'sid'in p||(i=a||{})):(e=>N(e)&&('domain'in e||'defaultState'in e||'name'in e))(s)&&(c=s,i=s.defaultState||{},u=s.domain),{hook:e,domain:u,defaultState:i,mainConfig:c,maybeConfig:f}}function s(e){let t=y.useContext(B);return e&&!t&&A('No scope found, consider adding <Provider> to app root'),t}function a(...e){return(({domain:e,defaultState:r,hook:n,mainConfig:o,maybeConfig:u})=>{function s(e){return n(s,e),null}let a=L({or:u,and:o}),l=`${e?`${e.compositeName.fullName}/`:''}${a.name||'gate'}`,i=j({name:`${l}.set`,sid:a.sid?`${a.sid}|set`:void 0}),c=j({name:`${l}.open`,sid:a.sid?`${a.sid}|open`:void 0}),f=j({name:`${l}.close`,sid:a.sid?`${a.sid}|close`:void 0}),p=C(Boolean(0),{name:`${l}.status`,serialize:'ignore'}).on(c,(()=>Boolean(1))).on(f,(()=>Boolean(0))),d=C(r,{name:`${l}.state`,sid:a.sid}).on(i,((e,t)=>t)).on(c,((e,t)=>t)).reset(f);if(e){let{hooks:t}=e;$({target:[t.store,t.store,t.event,t.event,t.event],params:[p,d,c,f,i]})}return s.open=c,s.close=f,s.status=p,s.state=d,s.set=i,t(`Gate:${l}`,s)})(u(l,e))}function l(e,t={}){let[r,n,o]=m([e.open,e.close,e.set]);((e,t={})=>{let r=y.useRef({value:null,count:0});O((()=>(e.open(r.current.value),()=>e.close(r.current.value))),[e]),((e,t)=>{if(e===t)return 1;if('object'==typeof e&&null!==e&&'object'==typeof t&&null!==t){let r=Object.keys(e),n=Object.keys(t);if(r.length!==n.length)return 0;for(let n=0;n<r.length;n++){let o=r[n];if(e[o]!==t[o])return 0}return 1}return 0})(r.current.value,t)||(r.current.value=t,r.current.count+=1),O((()=>{e.set(r.current.value)}),[r.current.count])})(y.useMemo((()=>({open:r,close:n,set:o})),[e,r]),t)}function i(e){return t=>{let r=c(e);return t.children(r)}}function c(e){return r(e,s(1))}function f(t){return((t,r)=>{let n=S.unit(t),o={};n?o={unit:t}:'@@unitShape'in t?'function'==typeof t['@@unitShape']?o=t['@@unitShape']():A('expect @@unitShape to be a function'):o=t;let u=Array.isArray(o),s=y.useRef({stale:1,justSubscribed:0,scope:r}),[a,l,i]=y.useMemo((()=>{s.current.stale=1;let e=Array.isArray(o)?[]:{},t=[],n=[];for(let u in o){let s=o[u];S.unit(s)||A('expect useUnit argument to be a unit'),S.event(s)||S.effect(s)?e[u]=r?x(s,{scope:r}):s:(e[u]=null,t.push(u),n.push(s))}return[e,t,n]}),[s,r,...Object.keys(o),...Object.values(o)]),c=y.useRef({value:a,storeKeys:l}),f=y.useCallback((t=>{let n=s.current;n.justSubscribed=1;let o=()=>{n.stale||(n.stale=1,t())},u=k.compute({priority:'sampler',batch:1}),a=i.map((t=>e(t,o,r,u)));return()=>{a.forEach((e=>e()))}}),[i,r,c,s]),p=y.useCallback((()=>{let e,t=c.current,o=s.current,f=0,p=t.value,d=t.storeKeys,m=r!==o.scope;if((l.length>0||d.length>0)&&(o.stale||o.justSubscribed||m)){f=!o.justSubscribed||m,e=u?[...a]:{...a},d.length!==l.length&&(f=1);for(let t=0;t<l.length;t++){let n=M(i[t],r),o=l[t];f||(f=d.includes(o)?p[o]!==n:1),e[o]=n}}return f&&(t.value=e),t.storeKeys=l,o.stale=0,o.justSubscribed=!f,o.scope=r,n?t.value.unit:t.value}),[f,i,r,c,s]);return E(f,p,p)})(t,s(1))}function p(e,o){return((e,o,u)=>{let s,a,l,i=[];'object'==typeof o&&null!==o?(o.keys&&(i=o.keys),({fn:s,getKey:a,placeholder:l}=o)):s=o,S.store(e)||A('expect useList first argument to be a store'),'function'!=typeof s&&A("expect useList's renderItem to be a function"),Array.isArray(i)||A("expect useList's keys to be an array");let c=y.useMemo((()=>{let r=t(`${e.shortName||'Unknown'}.Item`,(t=>{let{index:r,keys:o,keyVal:s,value:a}=t;if(f.current[1])return f.current[0](a,s);let l=n([{store:e,keys:[r,...o],fn:(e,t)=>e[t[0]]}],u);return f.current[0](l,r)}));return y.memo(r)}),[e,u,!!a]),f=y.useRef([s,a]);f.current=[s,a];let p=y.useMemo((()=>i),i);if(a){let t=r(e,u);return 0===t.length&&l?l:t.map((e=>{let t=f.current[1](e);return y.createElement(c,{keyVal:t,key:t,keys:p,value:e})}))}{let t=n([{store:e,keys:[e],fn:e=>e.length}],u);return 0===t&&l?l:Array.from({length:t},((e,t)=>y.createElement(c,{index:t,key:t,keys:p})))}})(e,o,s(1))}function d(e,t){let r=s(1);return n(t?[e,t]:[{store:e.store,keys:e.keys,fn:e.fn,updateFilter:e.updateFilter}],r)}function m(e){return((e,t)=>{if(!t)return e;let r=S.unit(e)||'object'!=typeof e?{event:e}:e;return y.useMemo((()=>{if(S.unit(e))return x(e,{scope:t});let r=Array.isArray(e)?[]:{};for(let n in e)r[n]=x(e[n],{scope:t});return r}),[t,...Object.keys(r),...Object.values(r)])})(e,s(1))}import y from'react';import b from'use-sync-external-store/shim/with-selector.js';import h from'use-sync-external-store/shim/index.js';import{step as k,createNode as v,clearNode as g,is as S,scopeBind as x,createEvent as j,createStore as C,launch as $}from'effector/effector.mjs';let A=e=>{throw Error(e)};const{useSyncExternalStore:E}=h,{useSyncExternalStoreWithSelector:w}=b,M=(e,t)=>t?t.getState(e):e.getState(),R=(e,t)=>e!==t;let O='undefined'!=typeof window?y.useLayoutEffect:y.useEffect,N=e=>'object'==typeof e&&null!==e,L=(e,t={})=>(N(e)&&(L(e.or,t),(e=>{for(let o in e)n=o,(e=>void 0===e)(r=e[o])||'or'===n||'and'===n||(t[n]=r);var r,n})(e),L(e.and,t)),t),K=e=>console.error(`${e} is deprecated`);const B=y.createContext(null);let{Provider:F}=B,U=(e,t,r)=>(K('createContextComponent'),n=>{let o=y.useContext(t),u=c(e);return r(n,u,o)}),V=()=>A('not implemented'),G=(e,t)=>(K('createReactState'),I(t)(e)),I=e=>r=>{let n=e;return'function'!=typeof e&&(n=r,r=e),t(`Connect(${n.displayName||n.name||'Unknown'})`,(e=>y.createElement(n,{...e,...c(r)})))};export{F as Provider,I as connect,V as createComponent,U as createContextComponent,a as createGate,G as createReactState,i as createStoreConsumer,m as useEvent,l as useGate,p as useList,c as useStore,d as useStoreMap,f as useUnit};
//# sourceMappingURL=scope.mjs.map
